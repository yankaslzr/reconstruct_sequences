# reconstruct_sequences

Reconstruction of FASTA sequences from Illumina targeted deep sequencing data, including
consensus-like reconstructions stratified by allele frequency (AF) thresholds for specific genes. It can be adapted to other targets, in this case it was used for pfmsp2.

## MSP2 haplotype reconstruction from targeted deep sequencing

This repository documents a workflow to reconstruct *Plasmodium falciparum* **MSP2**
gene sequences from Illumina targeted deep sequencing data.

Instead of generating a single consensus sequence per sample, this approach reconstructs
**sample-specific MSP2 haplotypes stratified by allele frequency (AF) thresholds**, allowing
the exploration of within-host diversity and minority variants.  
The resulting FASTA files are suitable for downstream analyses such as phylogenetics,
haplotype comparison, and diversity analyses (e.g. using MEGA).

---

## Data requirements

### Input files

- **VCF files**
  - Variant caller: Mutect2
  - Post-filtered
  - SNP and INDEL VCFs processed separately
  - Compressed with `bgzip` and indexed (`.vcf.gz` + `.tbi`)
  - One VCF per sample

- **Reference genome**
  - *Plasmodium falciparum* 3D7 reference genome  
  - `Pfalciparum.genome.fasta` (indexed with `samtools faidx`)

---

## Target gene

- Gene name: **msp2**
- Gene ID: **PF3D7_0206800**
- Chromosome: **Pf3D7_02_v3**
- Coordinates (1-based, inclusive): **271576–274917**


---

## Workflow overview

1. Normalize INDEL VCF files against the reference genome
2. Extract MSP2 SNP and INDEL variants from multiple VCF files using bcftools
3. Aggregate variants across samples into tab-separated tables (TSV)
4. Load the MSP2 reference sequence from the genome FASTA
5. Reconstruct haplotype sequences per sample using different AF cutoffs
6. Export reconstructed haplotypes in FASTA format
7. Optionally append the MSP2 reference sequence to the final FASTA file

---

## Allele frequency thresholds

Haplotype sequences are reconstructed using the following minimum AF cutoffs:

- AF ≥ 0.01  
- AF ≥ 0.05  
- AF ≥ 0.10  
- AF ≥ 0.20  
- AF ≥ 0.50  
- AF ≥ 0.90  

For each sample, one MSP2 sequence is generated per AF threshold.

---

## Scripts
Each script or command depends on the output generated by the previous step.

### 1. Generate MSP2 variant tables (command line)

File: *command-line_generate_variants*

This step extracts all variants overlapping the MSP2 locus from multiple
Mutect2 post-filtered VCF files and consolidates them into tab-separated tables.

# 1.1 SNP variants

This command extracts SNPs overlapping the MSP2 region.

**Input:**

- bgzipped and indexed SNP VCF files (*.vcf.gz)

**Output:**

- msp2_variants.tsv

This TSV file contains, per variant:

- Chromosome

- Position

- Reference allele

- Alternate allele

- Sample ID

- Allele frequency (AF)

This file is required for all downstream SNP-based reconstructions.

## 1.2 INDEL variants (with normalization)

INDEL VCF files must be normalized prior to extraction to ensure consistent representation of insertions and deletions.

Normalization is performed using bcftools norm against the reference genome.

**Input:**

- bgzipped and indexed INDEL VCF files (*.vcf.gz)

- Pfalciparum.genome.fasta

**Output (intermediate):**

- Normalized VCF files (*.norm.vcf.gz)

After normalization, INDELs overlapping the MSP2 locus are extracted into:

**Output:**

msp2_indels.tsv

This TSV file contains normalized INDEL positions and allele frequencies per sample.

Both msp2_variants.tsv (SNPs) and msp2_indels.tsv (INDELs) are required for full haplotype reconstruction including SNPs and INDELs.

## 2. Reconstruct MSP2 haplotype FASTA sequences

File: *generate_fasta_msp2.py*

This Python script performs the following steps:

- Loads the MSP2 reference sequence from the genome FASTA

- Reads variant tables (msp2_variants.tsv and/or msp2_indels.tsv)

- Applies multiple allele-frequency (AF) thresholds

- Reconstructs one MSP2 sequence per sample and AF cutoff

- Correctly handles insertions and deletions by tracking coordinate shifts

**Input:**

- msp2_variants.tsv (SNPs, optional)

- msp2_indels.tsv (INDELs, optional but recommended)

- Pfalciparum.genome.fasta

**Output:**

- msp2_haplotypes_AFthresholds.fasta (SNPs)

- msp2_INDEL_haplotypes_AFthresholds.fasta (INDELs)

- or combined SNP + INDEL FASTA files

FASTA headers include both the sample ID and the AF threshold used for sequence reconstruction.

## 3. Extract the MSP2 reference sequence

File: *generate_ref_fasta*

This step extracts the MSP2 reference sequence directly from the Plasmodium falciparum 3D7 reference genome using samtools faidx.

**Input:**

- Pfalciparum.genome.fasta

**Output:**

- PF3D7_0206800_reference.fasta

The reference sequence can be appended to the reconstructed FASTA file to facilitate alignment, visualization, and comparative analyses.

## 4. To do the same for INDELS data:
Follow the steps present in /scripts/indels/generate_indels_file

